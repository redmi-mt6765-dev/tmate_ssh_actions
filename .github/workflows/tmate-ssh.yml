name: Debug Actions

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Max GitHub limit

    steps:
      - name: Configure Git User
        run: |
          git config --global user.name "${{ secrets.USERNAME }}"
          git config --global user.email "${{ secrets.USER_EMAIL }}"

      - name: Import SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
          echo "SSH key configured."

      - name: Import GPG Key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format=long | awk '/sec/{print $2}' | cut -d'/' -f2 | head -n1)
          git config --global user.signingkey "$GPG_KEY_ID"
          git config --global commit.gpgsign true
          echo "GPG key configured for signing."

      - name: Start persistent tmate session
        run: |
          sudo apt-get update
          sudo apt-get install -y tmate
          tmate -F -k &
          sleep 5
          tmate show-messages
          echo "Tmate session started."
          
          echo "Type 'touch /stop' inside the tmate shell to end session."
          while true; do
            if [ -f /stop ]; then
              echo "Stop signal received. Ending workflow..."
              pkill tmate || true
              break
            fi
            sleep 5
          done
